#include <iostream>
#include <string>
#include <vector>
#include <cctype>
#include "Game.h"
#include "Timer.h"

#ifdef _WIN32
#include <windows.h>
#endif

namespace {
    const int TIME_LIMIT_SECONDS = 10;
    const int MIN_PLAYERS = 1;
    const int MAX_PLAYERS = 4;
}

static void SetupConsole() {
#ifdef _WIN32
    SetConsoleCP(1251);
    SetConsoleOutputCP(1251);
#endif
    setlocale(LC_ALL, "Russian");
}

static void ClearConsole() {
#ifdef _WIN32
    system("cls");
#else
    system("clear");
#endif
}

static void PrintRules() {
    std::cout << "\n=== ПРАВИЛА ИГРЫ 'ГОРОДА' ===\n";
    std::cout << "1. Игроки по очереди называют города\n";
    std::cout << "2. Каждый следующий город должен начинаться\n";
    std::cout << "   с последней буквы предыдущего\n";
    std::cout << "3. Буквы Ъ, Ы, Ь пропускаются\n";
    std::cout << "4. Города не должны повторяться\n";
    std::cout << "5. На ход дается " << TIME_LIMIT_SECONDS << " секунд\n";
    std::cout << "6. Для выхода введите 'exit'\n";
    std::cout << "============================\n\n";
}

static std::vector<std::string> GetCityDatabase() {
    return {
        // Города-миллионники
        "Москва", "Санкт-Петербург", "Новосибирск", "Екатеринбург",
        "Казань", "Нижний-Новгород", "Челябинск", "Самара",
        "Омск", "Ростов-на-Дону", "Уфа", "Красноярск",
        "Воронеж", "Пермь", "Волгоград", "Краснодар",

        // Крупные города (500тыс - 1млн)
        "Саратов", "Тюмень", "Тольятти", "Ижевск",
        "Барнаул", "Ульяновск", "Иркутск", "Хабаровск",
        "Ярославль", "Владивосток", "Махачкала", "Томск",
        "Оренбург", "Кемерово", "Новокузнецк", "Рязань",
        "Астрахань", "Набережные-Челны", "Пенза", "Липецк",
        "Киров", "Чебоксары", "Тула", "Калининград",
        "Курск", "Сочи", "Севастополь", "Ставрополь",

        // Средние города
        "Брянск", "Иваново", "Магнитогорск", "Белгород",
        "Тверь", "Владимир", "Симферополь", "Грозный",
        "Калуга", "Смоленск", "Вологда", "Саранск",
        "Якутск", "Мурманск", "Кострома", "Новгород",
        "Псков", "Петрозаводск", "Йошкар-Ола", "Ханты-Мансийск",
        "Сыктывкар", "Нальчик", "Черкесск", "Горно-Алтайск",
        "Кызыл", "Абакан", "Элиста", "Майкоп",

        // Города Золотого кольца
        "Суздаль", "Владимир", "Ярославль", "Кострома",
        "Иваново", "Ростов", "Переславль-Залесский", "Сергиев-Посад",

        // Города на букву А
        "Анапа", "Архангельск", "Ачинск", "Альметьевск",
        "Ангарск", "Арзамас", "Александров", "Апатиты",

        // Города на букву Б
        "Балашиха", "Балаково", "Бийск", "Благовещенск",
        "Братск", "Братск", "Бузулук", "Буйнакск",

        // Города на букву В
        "Великие-Луки", "Великий-Новгород", "Великий-Устюг", "Видное",
        "Винница", "Вознесенск", "Волгодонск", "Волжский",
        "Всеволожск", "Выборг", "Выкса", "Вязьма",

        // Города на букву Г
        "Гатчина", "Геленджик", "Глазов", "Голицыно",
        "Грозный", "Губаха", "Губкин", "Гудермес",

        // Города на букву Д
        "Дербент", "Дзержинск", "Димитровград", "Дмитров",
        "Долгопрудный", "Домодедово", "Дубна", "Дятьково",

        // Города на букву Е
        "Евпатория", "Ейск", "Екатеринбург", "Елабуга",
        "Елец", "Ессентуки", "Ефремов",

        // Города на букву Ж
        "Железноводск", "Железногорск", "Жигулевск", "Жуковский",

        // Города на букву З
        "Задонск", "Заинск", "Заречный", "Звенигород",
        "Зеленогорск", "Зеленоград", "Зеленодольск", "Златоуст",

        // Города на букву И
        "Ивангород", "Иваново", "Ивантеевка", "Ижевск",
        "Избербаш", "Изобильный", "Искитим", "Истра",

        // Города на букву К
        "Калининград", "Калуга", "Каменск-Уральский", "Камышин",
        "Канск", "Каспийск", "Кемерово", "Керчь",
        "Кизляр", "Кимры", "Кингисепп", "Кинешма",
        "Кириши", "Киров", "Кирово-Чепецк", "Кисловодск",
        "Клин", "Клинцы", "Ковров", "Когалым",
        "Коломна", "Комсомольск-на-Амуре", "Копейск", "Королев",
        "Костомукша", "Кострома", "Котельники", "Красногорск",
        "Краснодар", "Краснознаменск", "Краснотурьинск", "Красноярск",
        "Кропоткин", "Крымск", "Кстово", "Кубинка",
        "Кузнецк", "Кумертау", "Кунгур", "Курган",
        "Курск", "Курчатов", "Кушва", "Кызыл",

        // Города на букву Л
        "Лабинск", "Лабытнанги", "Лагань", "Ладушкин",
        "Лаишево", "Лакинск", "Лангепас", "Лахденпохья",
        "Лебедянь", "Лениногорск", "Ленинск", "Ленинск-Кузнецкий",
        "Ленск", "Лермонтов", "Лесной", "Лесозаводск",
        "Лесосибирск", "Ливны", "Ликино-Дулево", "Липецк",
        "Лиски", "Лихославль", "Лобня", "Лодейное-Поле",
        "Ломоносов", "Луга", "Луховицы", "Лысково",
        "Лысьва", "Лыткарино", "Льгов", "Любань",
        "Люберцы", "Любим", "Людиново", "Лянтор"
    };
}

int main() {
    SetupConsole();
    ClearConsole();

    Game game;
    game.LoadDatabase(GetCityDatabase());

    std::cout << "=== ИГРА 'ГОРОДА' ===\n\n";

    // Ввод количества игроков
    int playerCount = 0;
    do {
        std::cout << "Введите количество игроков (" << MIN_PLAYERS << "-" << MAX_PLAYERS << "): ";
        std::cin >> playerCount;
        std::cin.ignore();

        if (std::cin.fail()) {
            std::cin.clear();
            std::cin.ignore(10000, '\n');
            playerCount = 0;
        }
    } while (playerCount < MIN_PLAYERS || playerCount > MAX_PLAYERS);

    // Ввод имен игроков
    for (int i = 0; i < playerCount; ++i) {
        std::string name;
        std::cout << "Имя игрока " << (i + 1) << ": ";
        std::getline(std::cin, name);

        while (name.empty()) {
            std::cout << "Имя не может быть пустым. Введите имя игрока " << (i + 1) << ": ";
            std::getline(std::cin, name);
        }

        game.AddPlayer(name);
    }

    ClearConsole();
    PrintRules();

    std::string lastCity = "";
    bool isRunning = true;

    // Игровой цикл
    while (isRunning) {
        std::string currentPlayer = game.GetCurrentPlayer();
        std::cout << "\n--- Ход игрока: " << currentPlayer << " ---\n";

        if (!lastCity.empty()) {
            char lastChar = game.GetLastSignificantChar(lastCity);
            std::cout << "Последний город: " << lastCity << "\n";
            std::cout << "Нужна буква: '" << static_cast<char>(std::toupper(static_cast<unsigned char>(lastChar))) << "'\n";
        }
        else {
            std::cout << "Первый ход. Можно назвать любой город.\n";
        }

        // Таймер
        Timer timer;
        timer.Start(TIME_LIMIT_SECONDS);
        std::cout << "У вас есть " << TIME_LIMIT_SECONDS << " секунд. Введите город: ";

        std::string city;
        std::getline(std::cin, city);

        // Проверка времени
        if (timer.IsExpired()) {
            std::cout << "⏰ Время вышло! Ход переходит к следующему игроку.\n";
            game.NextPlayer();
            continue;
        }

        // Проверка выхода
        if (city == "exit" || city == "Exit" || city == "EXIT") {
            isRunning = false;
            break;
        }

        // Проверка на пустой ввод
        if (city.empty()) {
            std::cout << "❌ Город не может быть пустым!\n";
            continue;
        }

        // Проверка существования города
        if (!game.IsCityExist(city)) {
            std::cout << "❌ Ошибка: Город '" << city << "' не найден в базе данных!\n";
            continue;
        }

        // Проверка на повтор
        if (game.IsCityUsed(city)) {
            std::cout << "❌ Ошибка: Город '" << city << "' уже был использован!\n";
            continue;
        }

        // Проверка правила последней буквы
        if (!game.IsValidNextCity(lastCity, city) && !lastCity.empty()) {
            char expectedChar = game.GetLastSignificantChar(lastCity);
            std::cout << "❌ Ошибка: Город должен начинаться с буквы '"
                << static_cast<char>(std::toupper(static_cast<unsigned char>(expectedChar))) << "'!\n";
            continue;
        }

        // Все проверки пройдены
        game.AddCity(city);
        std::cout << "✅ Город '" << city << "' принят!\n";

        lastCity = city;
        game.NextPlayer();
    }

    // Статистика игры
    std::cout << "\n=== ИГРА ОКОНЧЕНА ===\n";
    std::cout << "Всего названо городов: " << game.GetUsedCitiesCount() << "\n";

    if (!game.IsUsedCitiesEmpty()) {
        std::cout << "Первый город: " << game.GetFirstUsedCity() << "\n";
        std::cout << "Последний город: " << game.GetLastCity() << "\n";

        std::cout << "\nСписок названных городов:\n";
        const auto& usedCities = game.GetUsedCities();
        for (size_t i = 0; i < usedCities.size(); ++i) {
            std::cout << (i + 1) << ". " << usedCities[i] << "\n";
        }
    }

    std::cout << "\nСпасибо за игру!\n";
    return 0;
}